<tool id="proteomics_search_msgfplus_1" name="MSGF+ MSMS Search" version="1.0.0">
	<requirements><requirement type="package">protkgem</requirement></requirements>
	<description>Run an MSGF+ Search</description>

	<command>
		#if $database.source_select=="built_in":
		msgfplus_search.rb --galaxy -d $database.dbkey --java-mem 8000M
		#else #msgfplus_search.rb -d $database.fasta_file
		#end if

		--var-mods='
		$variable_mods
		#for $custom_variable_mod in $custom_variable_mods:
		,${custom_variable_mod.custom_mod}
		#end for
		'

		--fix-mods='
		$fixed_mods
		#for $custom_fix_mod in $custom_fix_mods:
		,${custom_fix_mod.custom_mod}
		#end for
		'

		$input_file -o $output -r --enzyme=$enzyme --precursor-ion-tol-units=$precursor_tolu -v $missed_cleavages -f $fragment_ion_tol -p $precursor_ion_tol --instrument=$instrument
		
		
		
	</command>

	<inputs>	
		<conditional name="database">
			<param name="source_select" type="select" label="Database source">
				<option value="built_in">Built-In</option>
				<option value="input_ref">Your Upload File</option>
			</param>
			<when value="built_in">
				<param name="dbkey" type="select" format="text" >
					<label>Database</label>
					<options from_file="pepxml_databases.loc">
						<column name="name" index="0" />
						<column name="value" index="2" />
					</options>
				</param>
			</when>
			<when value="input_ref">
				<param name="fasta_file" type="data" format="fasta" label="Uploaded FASTA file" />
			</when>
		</conditional>
		
		<param name="input_file" type="data" format="mzml" multiple="false" label="MSMS File" help="An mzML file with MS/MS data"/>


		<param name="variable_mods" format="text" type="select" multiple="true" label="Variable Modifications" help="Hold the appropriate key while
			clicking to select multiple items">
			<options from_file="msgfplus_mods.loc">
				<column name="name" index="0" />
				<column name="value" index="2" />
			</options>
		</param>

		<repeat name="custom_variable_mods" title="Custom Variable Modifications" help="See https://bix-lab.ucsd.edu/pages/viewpage.action?pageId=13533355 for details on how to create these">
			<param name="custom_mod" type="text">
			</param>
		</repeat>
		
		
		<param name="fixed_mods" format="text" type="select" multiple="true" label="Fixed Modifications" help="Hold the appropriate key while
			clicking to select multiple items">
			<options from_file="msgfplus_mods.loc">
				<column name="name" index="0" />
				<column name="value" index="2" />
			</options>
		</param>

		<repeat name="custom_fix_mods" title="Custom Fixed Modifications" help="See https://bix-lab.ucsd.edu/pages/viewpage.action?pageId=13533355 for details on how to create these">
			<param name="custom_mod" type="text">
			</param>
		</repeat>
		
		

		<param name="missed_cleavages" type="select" format="text" help="Allow peptides to contain up to this many missed enzyme cleavage sites">
			<label>Missed Cleavages Allowed</label>
		    <option value="0">0</option>		
			<option value="1">1</option>
			<option value="2">2</option>
		</param>
		
		<param name="enzyme" type="select" format="text">
		    <label>Enzyme</label>
		    <option value="Trypsin">Trypsin</option>
		</param>
		
		<param name="instrument" type="select" format="text">
	    	<label>Instrument Type</label>
			<option value="2">TOF</option>
			<option value="0">Low-res LCQ/LTQ</option>
			<option value="1">High-res LTQ</option>
		</param>

		<param name="fragment_ion_tol" help="Fragment Ion Tolerance in Daltons" type="float" value="0.65" min="0" max="10000" label="Fragment ion tolerance"/>

		<param name="precursor_ion_tol" help="Precursor Ion Tolerance (Da or ppm)" type="float" value="100" min="0" max="10000" label="Precursor ion tolerance"/>
		<param name="precursor_tolu" type="select" format="text">
		    <label>Precursor Ion Tolerance Units</label>
		    <option value="ppm">ppm</option>		
			<option value="Da">Da</option>
		</param>
		
	</inputs>


	<outputs>
		<data format="raw_pepxml" name="output" metadata_source="input_file" label="MSGF+_vs_${database.dbkey if $database.has_key('dbkey') else $database.fasta_file.display_name}.${input_file.display_name}.${input_file.display_name}.pepXML"/>
	</outputs>


  <help>

**What it does**

Runs an MS/MS database search using the MSGFPlus search engine. Output is in the form of a pepXML file containing identified peptides along with their raw search scores.

----

**References**

Please see http://proteomics.ucsd.edu/Software/MSGFPlus.html for details of the MSGFPlus search engine and references describing its algorithm

  </help>

</tool>
